# openai-api-wrapper 詳細ドキュメント

## プロジェクト全体像

### アーキテクチャ概要

openai-api-wrapper は、以下のレイヤーで構成される**フルスタック**アプリケーションです。

* **プレゼンテーション層 (フロントエンド):**
  * Angular で実装
  * ユーザーインターフェースを提供
  * API クライアントとしてバックエンドと通信
* **API層 (バックエンド):**
  * Spring Boot で実装された REST API サーバー
  * フロントエンドからのリクエストを処理し、ビジネスロジック層へ委譲
  * OAuth2 プロキシ、WebSocket アップグレード処理、認証・認可機能を提供
* **ビジネスロジック層 (バックエンド):**
  * Java で実装されたドメインロジック
  * ユースケース、サービス、ドメインモデル (Entity, ValueObject, Enum) で構成
  * AIモデル連携、外部サービス連携、データ処理などのビジネスロジックを実装
* **データアクセス層 (バックエンド):**
  * TypeORM を使用した PostgreSQL へのデータアクセス
  * リポジトリパターンを適用し、データアクセスロジックを抽象化
* **インフラ層:**
  * クラウド環境 (GCP, AWS, Azure など) でのデプロイを想定
  * Docker, Kubernetes などコンテナ技術の活用を検討

**主要コンポーネント:**

* **API サーバー:**  REST API エンドポイント (`app.ts`, `routes.ts`, `controllers` ディレクトリ)
* **AI エージェント:**  バッチ処理、AI モデル連携 (`agent` ディレクトリ)
* **Web クライアント:** Angular アプリケーション (`angular` ディレクトリ)
* **データベース:** PostgreSQL (`db.ts`, `entity` ディレクトリ)
* **OAuth2 プロキシ:** 外部 OAuth2 プロバイダーとの連携 (`api-proxy.ts`)
* **WebSocket サーバー:** リアルタイム通信機能 (`chat.ts`)

**データフロー:**

1. ユーザーからのリクエストは、Angular フロントエンド (`angular` ディレクトリ) を経由して API サーバー (`app.ts`) に到達
2. API サーバーは、リクエストを適切なコントローラー (`controllers` ディレクトリ) にルーティング
3. コントローラーは、ビジネスロジック層 (`service` ディレクトリ) のサービスを呼び出し、処理を委譲
4. ビジネスロジック層は、データアクセス層 (`entity` ディレクトリ, `db.ts`) を通じてデータベース (PostgreSQL) にアクセスし、データの取得・更新
5. 必要に応じて、AI モデル (`openai-api-wrapper.ts`, `my-vertexai.ts` など) や外部サービス API クライアント (`api-box.ts`, `api-mattermost.ts` など) を利用
6. 処理結果を API サーバー経由でフロントエンドにレスポンス

### 主要機能

#### 多様なAIモデルの統合

このプロジェクトでは、以下のAIモデルを統合的に利用できます。

* **OpenAI:**  `gpt-4`, `gpt-3.5-turbo` など、高性能なテキスト生成モデルを活用し、高度な自然言語処理機能を提供します。テキスト要約、文章作成、コード生成など、幅広いタスクに対応可能です。
* **Vertex AI:** Google Cloud Platform (GCP) の Vertex AI 基盤を活用し、Gemini Pro, Gemini Flash, PaLM 2 などの最新モデルを利用します。特に Gemini モデルは、長文コンテキスト処理やマルチモーダル入力 (テキスト、画像、動画、音声) に強みを発揮し、高度なAI機能を実現します。
* **Anthropic:** Claude シリーズ (Claude 2, Claude Instant) を統合し、安全性と倫理性を重視したAIモデルを利用できます。長文テキストの処理や、クリエイティブなテキスト生成に強みを発揮します。
* **Mistral AI, Groq, DeepSeek:**  Mistral 7B, Mixtral 8x7B, Llama 2, Groq LPU などのオープンソース/商用モデルを統合し、多様なニーズに対応します。高速推論、低遅延処理、コスト効率などを重視したモデル選定が可能です。

これらのAIモデルは、`openai-api-wrapper.ts`, `my-vertexai.ts` などで抽象化された `OpenAIApiWrapper` クラスを通じて、統一的なインターフェースで利用できます。
これにより、機能開発者は、個々のモデルのAPI差異を意識することなく、目的に最適なモデルを柔軟に選択し、AI機能をアプリケーションに組み込むことができます。

#### 外部サービス連携

以下の外部サービスとの連携機能を備えています。

* **Box:**  Box API を利用したファイル管理機能を提供します。Box のファイルストレージを活用し、ドキュメント管理、コンテンツ共有、ファイルダウンロードなどの機能を提供します (`api-box.ts`)。
* **Mattermost:**  Mattermost API を利用したチャット連携機能を提供します。Mattermost のワークスペースと連携し、チームコラボレーション、情報共有、通知機能などを実現します (`api-mattermost.ts`)。
* **GitLab, Gitea:**  GitLab API, Gitea API を利用した Git リポジトリ連携機能を提供します。ソースコード管理、バージョン管理、変更履歴管理、ファイルコンテンツ取得などの機能を提供します (`api-gitlab.ts`, `api-gitea.ts`)。
* **Confluence:**  Confluence API を利用したドキュメント連携機能を提供します。Confluence のドキュメントコンテンツを検索、取得する機能を提供し、ナレッジマネジメントに貢献します (`confluence.ts`)。
* **Jira:**  Jira API を利用した課題管理連携機能を提供します。Jira の課題情報を検索、取得する機能を提供し、プロジェクト管理を効率化します (`jira.ts`)。

これらの外部サービス連携機能は、各APIクライアント (`api-box.ts`, `api-mattermost.ts` など) として実装され、OAuth2 認証 (`auth.ts`) を介してセキュアに利用できます。

#### モジュール性と拡張性

プロジェクトは、機能ごとに**モジュール**として分割された設計になっています。

* **認証モジュール (`auth.ts`, `entity/auth.entity.ts`)**: ユーザー認証、認可、セッション管理、APIキー発行など、認証認可に関わる機能を独立したモジュールとして実装
* **チャットモジュール (`chat.ts`, `chat-by-project-model.ts`)**: チャット機能、AIモデル連携、トークン数計算など、チャットに関わる機能をモジュール化
* **ファイル管理モジュール (`file-manager.ts`, `entity/file-models.entity.ts`)**: ファイルのアップロード、ダウンロード、管理など、ファイル操作に関わる機能をモジュールとして独立
* **API連携モジュール (`api-box.ts`, `api-mattermost.ts` など)**: 外部サービスとのAPI連携機能をプロバイダーごとにモジュール化

このようなモジュール分割により、**機能追加**や**変更**が容易になり、**保守性**と**拡張性**の高いシステムを実現しています。
新しいAIモデルや外部サービスとの連携機能も、モジュールを追加することで容易に拡張できます。

#### フルスタック構成

プロジェクトは、**フロントエンド** (Angular)、**バックエンド** (Spring Boot)、**データベース** (PostgreSQL) を含む**フルスタック**構成を採用しています。

* **フロントエンド:** Angular を採用し、**コンポーネントベース**でUIを構築。TypeScript による**型安全性**、**リアクティブプログラミング** (RxJS) による**非同期処理**、**Material Design** による**UIコンポーネント**などを活用し、**高品質**で**保守性**の高いクライアントアプリケーションを開発
* **バックエンド:** Java/Spring Boot を採用し、**DI (依存性注入)**、**AOP (アスペクト指向プログラミング)**、**トランザクション管理**などの Spring Framework の強力な機能と、**JPA (Java Persistence API)** による**O/Rマッピング**を活用し、**開発生産性**と**保守性**の高いサーバーアプリケーションを開発
* **データベース:** PostgreSQL を採用し、**高い信頼性**と**パフォーマンス**、**JSON** や **PostGIS** などの**拡張機能**を活用

**APIファースト**で設計されており、バックエンドとフロントエンドが明確に分離されています。
これにより、**並行開発**や**柔軟なデプロイ**が可能になり、**スケーラビリティ**と**可用性**の高いシステムを構築できます。

#### バッチ処理とリアルタイム処理

プロジェクトは、**バッチ処理**と**リアルタイム処理**の両方をサポートしています。

* **バッチ処理 (AIエージェント):**
  * `agent` ディレクトリに配置された AI エージェント (`BoxAgent` など) は、**大量データ**の**非同期処理**や**定期実行**タスク (例: ファイルダウンロード、データ分析、レポート生成) を効率的に行うための**バッチ処理**機能を提供
  * `BaseStep`, `MultiStep` などの基盤クラス (`base-step.ts`) を活用することで、**処理ステップ**を**モジュール化**し、**再利用性**と**保守性**の高いバッチ処理を実装可能
  * `main-batch.ts` スクリプトを通じて、**コマンドライン**から**エージェント**を実行可能
* **リアルタイム処理 (APIサーバー、チャット機能):**
  * APIサーバー (`app.ts`) は、**HTTPリクエスト**に対して**リアルタイム**に応答
  * チャット機能 (`chat.ts`) は、**WebSocket** を利用した**双方向通信**により、リアルタイムなメッセージング機能を提供
  * **SSE (Server-Sent Events)** を利用した**サーバープッシュ**機能も実装し、**イベントドリブン**なリアルタイム処理を実現

これらの処理方式を組み合わせることで、多様なユースケースに対応できる柔軟性の高いシステムを構築できます。

## ドキュメント構成

プロジェクトのドキュメントは、以下の構成で管理されています。

* `README.md` (プロジェクト概要): プロジェクトの概要、主要機能、セットアップ手順などを簡潔にまとめたトップページ
* `DETAILS.md` (詳細ドキュメント): プロジェクト全体像、アーキテクチャ、主要機能の詳細、APIリファレンス、開発・運用ガイドなどを網羅的に記述した詳細ドキュメント (**このファイル**)
* `docs` ディレクトリ:
  * `architecture` ディレクトリ: アーキテクチャ設計に関するドキュメント (`ARCHITECTURE_OVERVIEW.md`, `COMPONENT_DESIGN.md`, `DATA_MODEL_DESIGN.md`, `API_DESIGN.md`, `SECURITY_DESIGN.md`)
  * `development` ディレクトリ: 開発者向けドキュメント (`DEVELOPMENT_GUIDE.md`, `CODING_CONVENTION.md`, `TESTING_GUIDE.md`, `DEBUGGING_GUIDE.md`)
  * `operation` ディレクトリ: 運用者向けドキュメント (`DEPLOYMENT_GUIDE.md`, `MONITORING_GUIDE.md`, `TROUBLESHOOTING.md`)
  * `user_guide` ディレクトリ: 利用者向けドキュメント (`USER_MANUAL.md`, `FAQ.md`, `RELEASE_NOTES.md`)
  * `api_reference` ディレクトリ: API リファレンス (`openapi.yaml`, `openapi.json`, `api_client_sdk` ディレクトリ)

各ドキュメントへのリンクは [DOCUMENT_INDEX.md](DOCUMENT_INDEX.md) にまとめられています。

## 開発ガイド

開発に参加される方は、[CONTRIBUTING.md](CONTRIBUTING.md) を参照して、開発環境のセットアップ、コーディング規約、コミット規約、プルリクエスト手順などを確認してください。

## ライセンス

本プロジェクトは MIT License の下で公開されています。
詳細については [LICENSE.md](LICENSE.md) を参照してください。
